---
import Icon from '@/components/ui/Icon.astro';
import { cn } from '@/lib/cn';

interface Props {
  /** The npm command to copy */
  command?: string;
  /** Text shown after copying */
  copiedText?: string;
  /** Button size */
  size?: 'sm' | 'md' | 'lg';
  /** Color scheme for dark backgrounds */
  colorScheme?: 'default' | 'invert';
  /** Additional CSS classes */
  class?: string;
}

const {
  command = 'npm create velocity-astro@latest',
  copiedText = 'Copied!',
  size = 'lg',
  colorScheme = 'default',
  class: className,
} = Astro.props;

const isInvert = colorScheme === 'invert';

// Generate unique ID for this instance
const uniqueId = `npm-copy-${Math.random().toString(36).slice(2, 9)}`;

const sizes = {
  sm: 'h-8 px-3 text-xs',
  md: 'h-10 px-4 text-sm',
  lg: 'h-12 px-5 text-base',
};

const colorStyles = isInvert
  ? 'bg-on-invert text-surface-invert hover:bg-on-invert/90'
  : 'bg-foreground text-background hover:bg-foreground/90';

const secondaryTextColor = isInvert ? 'text-surface-invert/60' : 'text-secondary';
const successColor = 'text-success';
---

<button
  type="button"
  id={uniqueId}
  class={cn(
    'inline-flex items-center justify-center gap-2 rounded-md font-medium transition-all',
    'focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:outline-none',
    'active:scale-[0.98]',
    colorStyles,
    sizes[size],
    className
  )}
  data-command={command}
  data-copied={copiedText}
>
  <Icon name="terminal" size="md" />
  <span data-command-text>{command}</span>
  <span data-copy-icon class={cn('ml-1', secondaryTextColor)}>
    <Icon name="copy" size="sm" />
  </span>
  <span data-check-icon class={cn('ml-1 hidden', successColor)}>
    <Icon name="check" size="sm" />
  </span>
</button>

<script define:vars={{ uniqueId }}>
  function initCopyButton() {
    const button = document.getElementById(uniqueId);
    if (!button) return;

    const copyIcon = button.querySelector('[data-copy-icon]');
    const checkIcon = button.querySelector('[data-check-icon]');
    const commandText = button.querySelector('[data-command-text]');

    if (!copyIcon || !checkIcon || !commandText) return;

    // Prevent multiple listeners
    if (button.dataset.initialized) return;
    button.dataset.initialized = 'true';

    const command = button.dataset.command || 'npm create velocity-astro@latest';
    const copiedText = button.dataset.copied || 'Copied!';

    button.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(command);

        copyIcon.classList.add('hidden');
        checkIcon.classList.remove('hidden');
        commandText.textContent = copiedText;

        setTimeout(() => {
          copyIcon.classList.remove('hidden');
          checkIcon.classList.add('hidden');
          commandText.textContent = command;
        }, 2000);
      } catch {
        // Clipboard API failed - user will need to copy manually
      }
    });
  }

  initCopyButton();
  document.addEventListener('astro:page-load', initCopyButton);
</script>
